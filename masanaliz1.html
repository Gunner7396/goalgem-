// ... (CSS kısımları aynı kalabilir, sadece script içindeki calculate fonksiyonunu güncelliyoruz)

function calculate() {
    const hName = document.getElementById('h_name').value;
    const aName = document.getElementById('a_name').value;
    
    // BOŞ VERİ KONTROLÜ: Eğer isimler veya kritik veriler girilmemişse durdur.
    if (!hName || !aName || document.getElementById('h_npxG').value === "") {
        alert("Lütfen önce takımları ve metrikleri giriniz!");
        return;
    }

    const K = parseFloat(document.getElementById('leagueSelect').value);
    const league = document.getElementById('leagueSelect').options[document.getElementById('leagueSelect').selectedIndex].text;

    const h = { 
        npxG: parseV('h_npxG'), att: parseV('h_att'), sca: parseV('h_sca'), 
        prg: parseV('h_prg'), opp: parseV('h_opp'), tkl: parseV('h_tkl') 
    };
    const a = { 
        npxG: parseV('a_npxG'), att: parseV('a_att'), sca: parseV('a_sca'), 
        prg: parseV('a_prg'), opp: parseV('a_opp'), tkl: parseV('a_tkl') 
    };

    // Makine artık daha temkinli başlıyor
    let baseProb = 80; 
    let riskCounter = 0;

    // CEZA PUANLARI (Üst ihtimalini daha hızlı tetikler)
    [h, a].forEach(t => {
        // npxG/Sh çok kritik, aşılırsa büyük ceza
        if (t.npxG > (LIMITS.npxG * K)) { baseProb -= 20; riskCounter += 2; }
        // Ceza sahası dokunuşu fazlaysa tehlike
        if (t.att > (LIMITS.att * K)) { baseProb -= 15; riskCounter++; }
        // SCA (Pozisyon üretimi) fazlaysa ceza
        if (t.sca > (LIMITS.sca * K)) { baseProb -= 10; riskCounter++; }
        
        // Senin "Sınırda" uyarın: Eşiğe çok yakınsa (0.9 - 1.0 arası)
        if (t.npxG > (LIMITS.npxG * K * 0.85) && t.npxG <= (LIMITS.npxG * K)) {
            riskCounter += 1.5; 
            baseProb -= 5;
        }
    });

    // Eğer risk faktörleri çok biriktiyse (Örn: 4 ve üzeri) Alt ihtimalini çökert
    if(riskCounter >= 4) baseProb -= 15;

    const result = {
        id: Date.now(),
        league, hName, aName,
        p25: Math.max(Math.min(baseProb, 95), 5), // Min %5, Max %95
        p35: Math.max(Math.min(baseProb + 15, 99), 10),
        risk: riskCounter,
        status: 'pending'
    };

    const history = JSON.parse(localStorage.getItem('big5_data') || '[]');
    history.unshift(result);
    localStorage.setItem('big5_data', JSON.stringify(history));
    render();
    resetInputs(); // Analizden sonra formu temizle ki karışmasın
}

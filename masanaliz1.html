// 1. LİG BAZLI ORİJİNAL EŞİKLER (Anayasa)
const thresholds = {
    'Premier League': { npxg: 0.14, ppa: 12, third: 55, prgc: 18, dist: 16.8, coeff: 1.03 },
    'Bundesliga':     { npxg: 0.12, ppa: 10, third: 48, prgc: 15, dist: 17.2, coeff: 1.05 },
    'Serie A':        { npxg: 0.16, ppa: 14, third: 62, prgc: 16, dist: 16.5, coeff: 0.95 },
    'La Liga':        { npxg: 0.15, ppa: 13, third: 58, prgc: 14, dist: 16.8, coeff: 0.97 },
    'Ligue 1':        { npxg: 0.13, ppa: 11, third: 52, prgc: 16, dist: 17.5, coeff: 1.00 }
};

function analyzeMatch(league, data) {
    const thr = thresholds[league];
    let scores = {};

    // 2. HASSAS METRİK HESAPLAMA (Eşiğe Uzaklık & Logaritmik Artış)
    const calculateMetricScore = (val, target, weight, isDist = false) => {
        let ratio = isDist ? (target / val) : (val / target);
        
        // Azalan Verimler Yasası: Eşiğin 1.3 katından sonrası daha az puan verir (Absürt skor koruması)
        if (ratio > 1.3) {
            ratio = 1.3 + Math.log10(ratio - 0.2); 
        }
        
        // Sınırda Olma Çözümü: %90 altı çok sert düşer, %90-110 arası lineerdir
        let score = ratio * weight;
        return Math.min(score, weight * 1.5); // Maksimum tavan puanı
    };

    // 5 Temel Metrik Ağırlıklandırması
    scores.npxg = calculateMetricScore(data.npxg, thr.npxg, 35);
    scores.ppa  = calculateMetricScore(data.ppa,  thr.ppa,  25);
    scores.third = calculateMetricScore(data.third, thr.third, 15);
    scores.prgc = calculateMetricScore(data.prgc, thr.prgc, 15);
    scores.dist = calculateMetricScore(data.dist, thr.dist, 10, true);

    // 3. ZEKA KATMANI: YALANCI BASKI FİLTRESİ
    // Mesafe uzak ama sızma (PPA) çoksa puanı kır
    if (data.dist > thr.dist + 2 && data.ppa > thr.ppa) {
        scores.ppa *= 0.7; 
    }
    // Baskı (1/3) var ama kalite (npxG) yoksa puanı kır
    if (data.third > thr.third && data.npxg < thr.npxg * 0.8) {
        scores.third *= 0.6;
    }

    // 4. TOPLAM TANSİYON VE LİG KATSAYISI (±%5)
    let totalScore = Object.values(scores).reduce((a, b) => a + b, 0);
    let finalTension = Math.min(totalScore * thr.coeff, 98); // %98 Tavan Sınırı

    // 5. KADEMELİ GOL TEŞHİSİ
    let report = "";
    if (finalTension < 45) report = "KİLİT (A): Veriler kısırlığa işaret ediyor. 2.5 Alt güçlü.";
    else if (finalTension >= 78) report = "PATLAMA (B): Lig eşikleri geçildi, kaos hakim. 2.5 Üst radarında.";
    else report = "GRİ ALAN: Metrikler çelişkili veya tam sınırda. Canlı takip önerilir.";

    return { tension: finalTension.toFixed(1), diagnostic: report };
}
